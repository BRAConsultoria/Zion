<?/***	@copyright DEMP - Soluções em Tecnologia da Informação Ltda*	@author Pablo Vanni - pablovanni@gmail.com*	@since 01/06/2006*	<br>Última Atualização: 28/05/2007<br>*	<br>Última Atualização: 16/03/2010<br>*	<br>Última Atualização: 10/02/2011<br> Passow a Trabalhar com Vetores - Corrigidos Erros de Acesso - Muitooo Mais Rápida*	Autualizada Por: Pablo Vanni - pablovanni@gmail.com<br>*	@name Gera um menu para acesso aos módulos do sistema* 	@version 2.0*  	@package Framework*///Classes Nescessáriasinclude_once($_SESSION['FMBase'].'conexao.class.php');include_once($_SESSION['FMBase'].'menu_css.class.php');include_once($_SESSION['FMBase'].'menu.bd.php');class Menu extends MenuBD{    //Atributos da Classe    private $Css;    private $Html;    //Arrays Gerais    private $ArrayGrupo     = array();    private $ArrayModulo    = array();    private $ArrayPermissao = array();    private $GruposSelecionados   = array();    private $ModulosSemReferencia = array();    private $ModulosComReferencia = array();    private $ModulosReferentes    = array();    private $ArrayPacote = array();    /**    *	Metodo Construtor    *	@return VOID    */    public function __construct()    {        parent::MenuBd();        $this->Css  = new MenuCss();        $this->Html = "";    }    public function setHtml($Valor)    {        $this->Html.= $Valor;    }        public function getHtml()    {        return $this->Html;    }    public function geraMenu($UsuarioCod = "")    {        if(!is_numeric($UsuarioCod))            $UsuarioCod = $_SESSION['UsuarioCod'];        $this->ArrayGrupo     = $this->Con->execTodosArray(parent::gruposDiponiveisSql());        $this->ArrayModulo    = $this->Con->execTodosArray(parent::modulosDiponiveisSql(),null,"ModuloCod");        $this->ArrayPermissao = $this->Con->execTodosArray(parent::usuarioPermissaoModuloSql($UsuarioCod),"ModuloCod");        $this->processaDetalhes();        $AjusteLinha = (count($this->GruposSelecionados) * 119);        $this->setHtml("\n<div id=\"menu\" style=\"width:".$AjusteLinha."px; \">\n");        foreach($this->ArrayGrupo as $DadosGrupo)        {            if(!in_array($DadosGrupo['GrupoCod'],$this->GruposSelecionados)) continue;            $this->ArrayPacote[$DadosGrupo['GrupoCod']] = $DadosGrupo['Pacote'];            $this->setHtml($this->Css->iniciaGrupo($DadosGrupo['GrupoDesc']));            $this->geraModulos($DadosGrupo['GrupoCod']);            $this->setHtml($this->Css->finalizaGrupo());        }        $this->setHtml("</div>\n");        return $this->getHtml();    }    private function processaDetalhes()    {        $TodosModulos = array();        foreach($this->ArrayModulo as $DadosModulo)        {            $TodosModulos[$DadosModulo['ModuloCod']] = $DadosModulo['ModuloCod'];        }        $this->processaPermissoes($TodosModulos);        foreach($this->ArrayModulo as $DadosModulo)        {            if(in_array($DadosModulo['ModuloCod'], $this->ArrayPermissao))            $this->GruposSelecionados[$DadosModulo['GrupoCod']] = $DadosModulo['GrupoCod'];                        if(empty($DadosModulo['ModuloReferente']))                $this->ModulosSemReferencia[$DadosModulo['GrupoCod']][$DadosModulo['ModuloCod']] = $DadosModulo['ModuloCod'];                    else                    {                        $this->ModulosComReferencia[$DadosModulo['ModuloCod']] = $DadosModulo['ModuloReferente'];                        $this->ModulosReferentes[$DadosModulo['ModuloReferente']][] = $DadosModulo['ModuloCod'];                    }        }    }    private function processaPermissoes($TodosModulos)    {        foreach($TodosModulos as $ModuloCod)        {            if(!empty($this->ArrayModulo[$ModuloCod]['ModuloReferente']) and in_array($ModuloCod, $this->ArrayPermissao))            $this->analisaPermissaoRecursivo($ModuloCod);        }        $this->ArrayPermissao = array_unique($this->ArrayPermissao);    }    private function analisaPermissaoRecursivo($ModuloCod, $Buffer = array())    {        $Buffer[$ModuloCod] = $ModuloCod;                if(empty($this->ArrayModulo[$ModuloCod]['ModuloReferente']))        {            $this->ArrayPermissao = array_merge($this->ArrayPermissao,$Buffer);        }        else        {            $this->analisaPermissaoRecursivo($this->ArrayModulo[$ModuloCod]['ModuloReferente'],$Buffer);        }    }    private function geraModulos($GrupoCod)    {        $NModulos  = count($this->ModulosSemReferencia[$GrupoCod]);        //Inicia Módulo        $this->setHtml($this->Css->iniciaModulo());        if($NModulos > 0)        {            foreach($this->ModulosSemReferencia[$GrupoCod] as $ModuloCod)            $this->geraModulo($ModuloCod);        }        //Finaliza Módulo        $this->setHtml($this->Css->finalizaModulo());    }    private function geraModulo($ModuloCod)    {        //Se módulo Possui Sub Modulo        if(in_array($ModuloCod, $this->ModulosComReferencia))        {            return $this->geraSubModulo($ModuloCod);        }        $DadosModulo = $this->ArrayModulo[$ModuloCod];        if(in_array($ModuloCod, $this->ArrayPermissao) and $DadosModulo['VisivelMenu'] == 'S')            $this->setHtml($this->Css->populaModulo($DadosModulo['ModuloNome'], $DadosModulo['ModuloDesc'], $DadosModulo['NomeMenu'],$this->ArrayPacote[$DadosModulo['GrupoCod']], $DadosModulo['ModuloBase']));    }    private function geraSubModulo($ModuloCod)    {        $DadosSubModulo = $this->ArrayModulo[$ModuloCod];        $NModulos = count($this->ModulosReferentes[$ModuloCod]);        if($NModulos > 0 and in_array($ModuloCod, $this->ArrayPermissao))        {            $this->setHtml($this->Css->iniciaSubModulo($DadosSubModulo['ModuloDesc'], $DadosSubModulo['NomeMenu']));            foreach($this->ModulosReferentes[$ModuloCod] as $ReferenciaCod)            {                if(in_array($ReferenciaCod, $this->ModulosComReferencia))                    $this->geraSubModulo($ReferenciaCod);                        else                            $this->geraModulo($ReferenciaCod);            }            //Finaliza Sub Módulo            $this->setHtml($this->Css->finalizaSubModulo());        }    }}